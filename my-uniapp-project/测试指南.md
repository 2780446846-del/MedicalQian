# 🎯 WebRTC 直播功能测试指南

## ✅ 问题已修复

### 问题原因
之前的代码执行顺序错误：
1. ❌ 创建 WebRTC 实例
2. ❌ 创建直播间（观众可以立即加入）
3. ❌ 获取摄像头流
4. ❌ 设置本地流 ← **太晚了！观众已经加入但没有流**

### 修复后的顺序
1. ✅ 获取摄像头流
2. ✅ 创建 WebRTC 实例
3. ✅ **立即设置本地流** ← **关键步骤**
4. ✅ 创建直播间
5. ✅ 观众加入时本地流已经准备好

---

## 📋 测试步骤

### 1️⃣ 启动后端服务器

```bash
cd houduan
node app.js
```

**预期输出**：
```
服务器运行在 http://localhost:3000
WebRTC 信令服务器运行在 ws://localhost:8080
```

### 2️⃣ 医生端开始直播

1. 打开医生直播页面 (`pages/doctor/live.vue`)
2. 输入直播主题（例如："心血管健康科普"）
3. 点击"开始直播"按钮
4. **观察控制台输出**（应该看到以下日志）：

```
⏳ 等待摄像头流准备...
🎬 renderjs: 开始启动摄像头...
✅ 摄像头流已获取
- 视频轨道数: 1
- 音频轨道数: 1
📹 收到来自 renderjs 的视频流
视频轨道数: 1
音频轨道数: 1
🚀 开始初始化 WebRTC...
✅ 本地流已设置到 WebRTC  ← 关键！
🔌 连接信令服务器...
WebRTC 初始化成功
updateStream: start
🏠 创建直播间: room_xxx
直播间创建成功: room_xxx
✅ 直播间创建成功: room_xxx
🎉 直播启动完成！本地流已准备好，观众可以正常观看了
```

5. **确认**：
   - ✅ 能看到自己的摄像头画面
   - ✅ 显示"直播中"标识
   - ✅ 控制台显示"本地流已设置到 WebRTC"

### 3️⃣ 观众端观看直播

1. 打开观众观看页面 (`pages/viewer/live.vue`)
2. 输入直播间ID（从医生端控制台复制 `room_xxx`）
3. 点击"加入直播间"按钮
4. **观察控制台输出**（应该看到以下日志）：

```
🔌 连接信令服务器...
WebRTC 初始化成功
🏠 加入直播间: room_xxx
观众加入: 观众_xxx
收到远程流: MediaStream {id: "xxx", active: true}  ← 关键！
- 视频轨道数: 1
- 音频轨道数: 1
✅ 远程视频流已设置
```

5. **确认**：
   - ✅ 能看到医生的直播画面
   - ✅ 显示医生信息和直播主题
   - ✅ 控制台显示"收到远程流"

### 4️⃣ 医生端确认观众加入

医生端控制台应该显示：
```
👤 观众加入: 观众_xxx
开始为观众 viewer_xxx 创建连接  ← 现在有本地流了！
✅ 已为观众 viewer_xxx 添加本地流轨道
```

---

## 🔍 关键检查点

### ✅ 成功的标志

**医生端**：
- [ ] 控制台显示"✅ 本地流已设置到 WebRTC"
- [ ] 控制台显示"✅ 已为观众 xxx 添加本地流轨道"
- [ ] 能看到自己的摄像头画面
- [ ] 观众加入时有系统消息提示

**观众端**：
- [ ] 控制台显示"收到远程流"
- [ ] 控制台显示"视频轨道数: 1"
- [ ] 能看到医生的直播画面
- [ ] 画面流畅，无黑屏

### ❌ 如果还有问题

**医生端看不到摄像头**：
- 检查浏览器是否授予摄像头权限
- 检查是否有其他应用占用摄像头
- 查看控制台是否有错误信息

**观众端看不到画面**：
1. 确认医生端控制台显示"本地流已设置到 WebRTC"
2. 确认观众端控制台显示"收到远程流"
3. 检查网络连接（WebSocket 是否正常）
4. 尝试刷新页面重新加入

**控制台显示"本地流不存在"**：
- 这个错误应该已经修复了
- 如果还出现，说明代码没有正确保存
- 请完全刷新页面（Ctrl+Shift+R）

---

## 🎉 预期结果

1. **医生端**：
   - 点击"开始直播"后，先获取摄像头
   - 摄像头准备好后，自动初始化 WebRTC
   - 本地流设置完成后，才创建直播间
   - 观众加入时，本地流已经准备好

2. **观众端**：
   - 加入直播间后，立即收到医生的视频流
   - 能正常看到医生的直播画面
   - 画面流畅，无延迟

3. **后端服务器**：
   - 正确转发信令消息
   - 管理直播间和观众列表
   - 处理 WebRTC 连接协商

---

## 📝 核心代码改动

### `pages/doctor/live.vue` - `startLive()` 函数

**之前**：先创建 WebRTC 和直播间，再获取摄像头
**现在**：先获取摄像头，在 `setWebRTCStream()` 中初始化 WebRTC

### `pages/doctor/live.vue` - `setWebRTCStream()` 函数

**之前**：只是简单设置流
**现在**：完整的 WebRTC 初始化流程
1. 创建 WebRTC 实例
2. **立即设置本地流**（关键！）
3. 设置回调
4. 连接信令服务器
5. 创建直播间

---

## 🚀 开始测试

现在请按照上面的步骤测试，应该可以正常观看直播了！

如果还有问题，请提供：
1. 医生端完整控制台输出
2. 观众端完整控制台输出
3. 后端服务器控制台输出

祝测试顺利！🎊

